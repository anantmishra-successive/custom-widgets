System.register(["jimu-core","jimu-ui","esri/form/FormTemplate","esri/rest/support/Query","esri/form/elements/FieldElement","esri/form/elements/GroupElement","esri/widgets/FeatureForm","esri/Graphic","esri/layers/FeatureLayer","jimu-arcgis","esri/core/reactiveUtils","esri/widgets/Editor"],function(e,t){var o={},r={},i={},n={},a={},l={},s={},d={},c={},u={},v={},f={};return{setters:[function(e){o.DataSourceComponent=e.DataSourceComponent,o.DataSourceManager=e.DataSourceManager,o.DataSourceTypes=e.DataSourceTypes,o.ExBAddedJSAPIProperties=e.ExBAddedJSAPIProperties,o.Immutable=e.Immutable,o.JSAPILayerTypes=e.JSAPILayerTypes,o.React=e.React,o.ServiceManager=e.ServiceManager,o.SessionManager=e.SessionManager,o.SupportedLayerServiceTypes=e.SupportedLayerServiceTypes,o.WidgetVersionManager=e.WidgetVersionManager,o.classNames=e.classNames,o.css=e.css,o.dataSourceUtils=e.dataSourceUtils,o.defaultMessages=e.defaultMessages,o.esri=e.esri,o.hooks=e.hooks,o.jsx=e.jsx,o.privilegeUtils=e.privilegeUtils,o.useIntl=e.useIntl},function(e){r.Button=e.Button,r.ConfirmDialog=e.ConfirmDialog,r.Loading=e.Loading,r.Select=e.Select,r.TextInput=e.TextInput,r.WidgetPlaceholder=e.WidgetPlaceholder,r.defaultMessages=e.defaultMessages},function(e){i.default=e.default},function(e){n.default=e.default},function(e){a.default=e.default},function(e){l.default=e.default},function(e){s.default=e.default},function(e){d.default=e.default},function(e){c.default=e.default},function(e){u.JimuMapViewComponent=e.JimuMapViewComponent,u.SnappingUtils=e.SnappingUtils},function(e){v.watch=e.watch},function(e){f.default=e.default}],execute:function(){e((()=>{var e={170:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0m-1.27 4.936a6.5 6.5 0 1 1 .707-.707l4.136 4.137a.5.5 0 1 1-.707.707z" clip-rule="evenodd"></path></svg>'},190:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path fill="#000" fill-rule="evenodd" d="m14.071 2.828 1.414-1.414 2.829 2.829-1.415 1.414zm-.707.708L8.038 8.86l.236 2.593 2.593.236 5.325-5.326zm-6.01 8.838 3.889.354 8.485-8.485L15.485 0 7 8.485zM8.5 3H0v17h17v-8.5h-1V19H1V4h7.5z" clip-rule="evenodd"></path></svg>'},228:e=>{"use strict";e.exports=a},243:e=>{"use strict";e.exports=v},244:e=>{"use strict";e.exports=o},277:e=>{"use strict";e.exports=l},321:e=>{"use strict";e.exports=r},387:e=>{"use strict";e.exports=s},410:e=>{"use strict";e.exports=i},470:e=>{"use strict";e.exports=d},508:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6.5 7.5A.5.5 0 0 1 7 7h1.5v4.5h1a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0-1h1V8H7a.5.5 0 0 1-.5-.5"></path><path fill="#000" fill-rule="evenodd" d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16m0-1A7 7 0 1 0 8 1a7 7 0 0 0 0 14" clip-rule="evenodd"></path></svg>'},510:e=>{"use strict";e.exports=n},633:e=>{"use strict";e.exports=c},662:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M7.5 0a.5.5 0 0 0-.5.5V7H.5a.5.5 0 0 0 0 1H7v6.5a.5.5 0 0 0 1 0V8h6.5a.5.5 0 0 0 0-1H8V.5a.5.5 0 0 0-.5-.5"></path></svg>'},686:e=>{"use strict";e.exports=u},816:e=>{"use strict";e.exports=f},996:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8 2.125 14.334 14H1.667zm-.882-.47a1 1 0 0 1 1.765 0l6.333 11.874A1 1 0 0 1 14.334 15H1.667a1 1 0 0 1-.882-1.47zM8 4.874a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0L8.9 5.87a.905.905 0 0 0-.9-.995m1 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd"></path></svg>'}},t={};function p(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,p),i.exports}p.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return p.d(t,{a:t}),t},p.d=(e,t)=>{for(var o in t)p.o(t,o)&&!p.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},p.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),p.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},p.p="";var m={};return p.p=window.jimuConfig.baseUrl,(()=>{"use strict";p.r(m),p.d(m,{__set_webpack_public_path__:()=>et,default:()=>Xe});var e,t,o,r,i=p(244);!function(e){e.Attribute="ATTRIBUTE",e.Geometry="GEOMETRY"}(e||(e={})),function(e){e.Webmap="WEBMAP",e.Custom="CUSTOM"}(t||(t={})),function(e){e.NoMap="NOMAP",e.NoLayer="NOEDITABLE"}(o||(o={})),function(e){e.Prescriptive="PRESCRIPTIVE",e.Flexible="FLEXIBLE"}(r||(r={}));var n=p(321),a=p(410);const l={_widgetLabel:"Edit",initAttEmptyMessage:"Please add an editable source.",noRecordTips:"No valid record is selected, select one or add one.",addFeature:"Add feature",update:"Update",deleteRecord:"Delete this record?",deleteRecordTips:"This record will be permanently removed.",keepRecord:"Keep record",_action_edit_label:"Edit",selectionChangeConfirmTitle:"Discard the edits?",selectionChangeConfirmTips:"You have unsaved edits that could be lost.",discardConfirm:"Discard edits",discardCancel:"Continue editing",ownerAdminNotice:"Editing is restricted but you have privileges to edit this layer."},s=["CreationDate","Creator","EditDate","Editor","GlobalID"],d=[i.JSAPILayerTypes.FeatureLayer,i.JSAPILayerTypes.SceneLayer,i.JSAPILayerTypes.BuildingComponentSublayer,i.JSAPILayerTypes.OrientedImageryLayer,i.JSAPILayerTypes.SubtypeSublayer],c=(0,i.Immutable)([i.DataSourceTypes.FeatureLayer,i.DataSourceTypes.SceneLayer,i.DataSourceTypes.BuildingComponentSubLayer,i.DataSourceTypes.OrientedImageryLayer,i.DataSourceTypes.SubtypeSublayer]),u=(e,t)=>!!e&&(Array.isArray(e)?null==e?void 0:e.join().toLowerCase().includes(t):null==e?void 0:e.toLowerCase().includes(t)),v=e=>{const t=null==e?void 0:e.allowGeometryUpdates,o=null==e?void 0:e.capabilities;return{allowGeometryUpdates:t,create:u(o,"create"),update:u(o,"update"),deletable:u(o,"delete")}};function f(e){if(!e)return[];const t=e.objectIdField,{creationDateField:o,creatorField:r,editDateField:i,editorField:n}=e.editFieldsInfo||{},{shapeAreaFieldName:a,shapeLengthFieldName:l}=e.geometryProperties||{};return[t,o,r,i,n,a,l].filter(Boolean)}const g=e=>{const t=[];return null==e||e.forEach(e=>{"group"===e.type?t.push(...g(e.elements)):t.push(e)}),t},y=e=>i.DataSourceManager.getInstance().getDataSource(e),h=e=>{const t=(null==e?void 0:e.type)===i.DataSourceTypes.SceneLayer||(null==e?void 0:e.type)===i.DataSourceTypes.BuildingComponentSubLayer;null==e||e.type,i.DataSourceTypes.OrientedImageryLayer;let o;return o=t?e.getAssociatedDataSource():e,o};var b=p(510),w=p(228),S=p(277),x=function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(e){n(e)}}function l(e){try{s(r.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,l)}s((r=r.apply(e,t||[])).next())})};const E="esri-item-list",F="esri-widget",j="esri-editor__header",C="esri-feature-form__form-header",R="esri-feature-form__description-text",I="esri-button--disabled",N="esri-widget__heading",k="esri-feature-form",O="esri-editor__scroller",L="esri-editor__content",_="esri-item-list__list",T="esri-item-list__group",D="esri-item-list__no-matches-message",M="esri-item-list__list-item-label",A="esri-item-list__list-item-container",V="esri-item-list__list-item",P="esri-item-list__group-header",U="esri-editor__back-button",$="esri-widget__heading",B="esri-editor__warning-option",J="esri-editor__warning-option--primary",W="esri-editor__warning-option--positive",G="esri-editor__prompt--danger",z="esri-editor__prompt__header",H="esri-editor__prompt__header__heading",Z="esri-editor__prompt__message",q="esri-editor__prompt__divider",K="esri-editor__prompt__actions",Y=e=>{const t=[];for(const o in e)(null==e?void 0:e[o])&&t.push(...e[o]);return t},Q=(e,t)=>{const o=[],r=null==t?void 0:t.dataSourceId;for(const t in e)0===t.indexOf(r)&&(null==e?void 0:e[t])&&o.push(...e[t]);return o};const X=e=>x(void 0,void 0,void 0,function*(){if(!e)return!1;const t=i.esri.restRequest.request;try{const o=yield t(`${e}?f=json`);return!Object.keys(o).includes("error")}catch(e){return!1}}),ee=e=>x(void 0,void 0,void 0,function*(){var t;const o=yield null==e?void 0:e.fetchItemInfo().then(e=>e).catch(e=>{console.error(e)});if(!o||!o.url)return!1;const r=null===(t=yield i.ServiceManager.getInstance().fetchArcGISServerInfo(o.url))||void 0===t?void 0:t.owningSystemUrl;if(!r)return!1;const n=i.SessionManager.getInstance().getSessionByUrl(r);if(!n)return!1;const a=yield n.getUser(),l="org_admin"===(null==a?void 0:a.role),s=null==o?void 0:o.isOrgItem,d=((null==a?void 0:a.privileges)||[]).includes("portal:admin:updateItems"),c=l&&s&&d,u=o.owner===(null==a?void 0:a.username),v=yield i.privilegeUtils.isItemInTheUpdatedGroup(o.id,n);return c||u||v}),te=e=>i.dataSourceUtils.getTimezoneAPIFromRuntime(e.getTimezone()),oe=e=>{var t;const o=null==e?void 0:e.getLayerDefinition(),r=null===(t=e.belongToDataSource)||void 0===t?void 0:t.getLayerDefinition();return(null==o?void 0:o.displayField)||(null==r?void 0:r.displayField)||(null==o?void 0:o.objectIdField)||(null==r?void 0:r.objectIdField)||"OBJECTID"},re=e=>({layer:e,enabled:!1,addEnabled:!1,updateEnabled:!1,deleteEnabled:!1,attributeUpdatesEnabled:!1,geometryUpdatesEnabled:!1,attachmentsOnUpdateEnabled:!1}),ie=(e,t,o)=>e.filter(e=>!t.includes(e.jimuName)).map(e=>{if(e.children)return new S.default({label:e.name,description:e.subDescription||(null==e?void 0:e.description),elements:e.children.filter(e=>!t.includes(e.jimuName)).map(e=>new w.default({fieldName:e.jimuName,label:e.alias||e.name,description:e.subDescription||e.description,editableExpression:e.editAuthority?"true":"false"}))});{const t=o.find(t=>t.fieldName===e.jimuName),r=t?t.clone():new w.default({fieldName:e.jimuName,label:(null==e?void 0:e.alias)||(null==e?void 0:e.name)});return r.description=e.subDescription||(null==e?void 0:e.description),r.editableExpression=e.editAuthority&&!r.valueExpression?"true":"false",r}}),ne=(e,o,r,n,l)=>x(void 0,void 0,void 0,function*(){let s,d=!1;const c=r.layer,u=null==c?void 0:c.userHasFullEditingPrivileges,p=yield ee(e),m=c.editingEnabled;let y=o;y||(y=((e,o)=>{var r,n,a,l,s;const d=e.getLayerDefinition(),{allowGeometryUpdates:c,create:u,update:p,deletable:m}=v(d),y=(null===(a=null===(n=null===(r=e.getSchema())||void 0===r?void 0:r.fields)||void 0===n?void 0:n.asMutable)||void 0===a?void 0:a.call(n,{deep:!0}))||{};let h=Object.values(y);h=h.filter(e=>!f(d).includes(e.name));const b=null===(l=o.formTemplate)||void 0===l?void 0:l.elements;if(b){const e=g(b).filter(e=>"field"===e.type).map(e=>e.fieldName);h=h.filter(t=>e.includes(t.name))}(null==h?void 0:h.length)>50&&(h=h.slice(0,50));const w=(null==d?void 0:d.fields)||[],S=h.map(e=>{const t=w.find(t=>t.name===e.jimuName),o=null==t?void 0:t.editable;return Object.assign(Object.assign({},e),{editAuthority:o,subDescription:(null==e?void 0:e.description)||"",editable:o})}),x={dataSourceId:e.id,mainDataSourceId:e.id,dataViewId:e.dataViewId,rootDataSourceId:null===(s=e.getRootDataSource())||void 0===s?void 0:s.id};return{id:e.id,name:e.getLabel(),useDataSource:(0,i.Immutable)(x),addRecords:u,deleteRecords:m,updateRecords:p,updateAttributes:p,updateGeometries:c&&p,showFields:h,groupedFields:S,layerHonorMode:t.Webmap}})(e,c));const h=e.getLayerDefinition(),b=f(h),w=((e,o,r,i)=>{const{groupedFields:n,layerHonorMode:l}=o,s=e.formTemplate,d=s?s.clone():new a.default,c=((null==s?void 0:s.elements)||[]).filter(e=>"field"===e.type);if(l===t.Custom&&(d.elements=ie(n,i,c)),!r&&d.elements)for(const e of d.elements)"relationship"===e.type&&(e.editableExpression="false");return d.title=(null==s?void 0:s.title)||e.title,d})(c,y,n,b);if(p||u)d=!0,s={layer:c,formTemplate:w,enabled:!0,addEnabled:!0,updateEnabled:!0,deleteEnabled:!0,attributeUpdatesEnabled:!0,geometryUpdatesEnabled:!0};else if(m&&e){const{addRecords:e,deleteRecords:t,updateRecords:o,updateAttributes:r,updateGeometries:i}=y;(p||(o||t))&&(d=!0);const n=(yield X(null==c?void 0:c.url))||l,{allowGeometryUpdates:a,create:u,update:f,deletable:m}=v(h);s={layer:c,formTemplate:w,enabled:n&&(e||o||t),addEnabled:e&&u,updateEnabled:o&&f,deleteEnabled:t&&m,attributeUpdatesEnabled:r&&f,geometryUpdatesEnabled:i&&a}}else s=re(c);return{showUpdateBtn:d,editorLayerInfo:s}}),ae=(e,t)=>{var o;const{addFeatures:r=[],updateFeatures:i=[],deleteFeatures:n=[]}=t;for(const t of r){const o=e.buildRecord(t);e.afterAddRecord(o)}const a=e.getIdField();for(const t of i){const r=t.attributes[a],i=null===(o=e.getRecordById(r))||void 0===o?void 0:o.feature,n=(null==i?void 0:i.attributes)||{},l=Object.assign(n,null==t?void 0:t.attributes);t.attributes=l;const s=e.buildRecord(t);e.afterUpdateRecord(s)}for(const t of n){const o=e.buildRecord(t);e.afterDeleteRecordById(o.getId())}},le=(e,t)=>x(void 0,void 0,void 0,function*(){const o=e.dataSource,r=e.layer,i=o.getGDBVersion();return r.applyEdits(t,{gdbVersion:i})});var se=p(508),de=p.n(se),ce=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(o[r[i]]=e[r[i]])}return o};const ue=e=>{const t=window.SVG,{className:o}=e,r=ce(e,["className"]),n=(0,i.classNames)("jimu-icon jimu-icon-component",o);return t?i.React.createElement(t,Object.assign({className:n,src:de()},r)):i.React.createElement("svg",Object.assign({className:n},r))},ve=e=>{const{emptyTips:t}=e;return(0,i.jsx)("div",{className:"surface-1 border-0 h-100",css:i.css`
    .edit-blank {
      min-height: 300px;
      .placeholder-icon{
        color: var(--ref-palette-neutral-800);
      }
      & > div{
        top: calc(50% + 20px);
        transform: translateY(-50%);
      }
      p{
        font-size: 14px;
        margin-top: 16px;
        line-height: 19px;
        color: var(--ref-palette-neutral-1000);
      }
    }
  `},(0,i.jsx)("div",{className:"w-100 text-center edit-blank"},(0,i.jsx)("div",{className:"position-absolute edit-blank-content w-100"},(0,i.jsx)(ue,{size:32,className:"placeholder-icon"}),(0,i.jsx)("p",null,t))))};var fe=p(996),pe=p.n(fe),me=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(o[r[i]]=e[r[i]])}return o};const ge=e=>{const t=window.SVG,{className:o}=e,r=me(e,["className"]),n=(0,i.classNames)("jimu-icon jimu-icon-component",o);return t?i.React.createElement(t,Object.assign({className:n,src:pe()},r)):i.React.createElement("svg",Object.assign({className:n},r))},ye=e=>{const{title:t,message:o,confirmText:r,cancelText:a,onConfirm:l,onCancel:s}=e;return(0,i.jsx)(i.React.Fragment,null,(0,i.jsx)("div",{className:"confirm-scrim",css:i.css`
    &.confirm-scrim{
      position: absolute;
      background-color: var(--calcite-scrim-background);
      width: 100%;
      height: 100%;
      top: 0;
    }
  `}),(0,i.jsx)("div",{className:G,css:i.css`
    &.confirm-scrim{
      position: absolute;
      background-color: var(--calcite-scrim-background);
      width: 100%;
      height: 100%;
      top: 0;
    }
    .esri-editor__prompt__actions{
      .esri-editor__warning-option--primary,
      .esri-editor__warning-option--positive{
        text-align: center;
        padding: 4px 16px;
        line-height: 22px;
        border: 1px solid var(--calcite-ui-danger);
        border-radius: 0;
        flex: 1;
      }
      .esri-editor__warning-option--primary{
        background-color: transparent;
        color: var(--calcite-ui-danger);
        :hover{
          border-color: var(--calcite-ui-danger-hover);
          color: var(--calcite-ui-danger-hover);
          box-shadow: inset 0 0 0 1px var(--calcite-ui-danger-hover);
        }
      }
      .esri-editor__warning-option--positive{
        background-color: var(--calcite-ui-danger);
        color: var(--ref-palette-white);
        :hover{
          border-color: var(--calcite-ui-danger-hover);
          background-color: var(--calcite-ui-danger-hover);
        }
      }
    }
  `},(0,i.jsx)("div",{className:z},(0,i.jsx)(ge,{width:24,height:24}),(0,i.jsx)("h4",{className:(0,i.classNames)($,H)},t)),(0,i.jsx)("div",{className:Z},o),(0,i.jsx)("div",{className:q}),(0,i.jsx)("div",{className:K},(0,i.jsx)(n.Button,{className:(0,i.classNames)(B,J),onClick:s},a),(0,i.jsx)(n.Button,{className:(0,i.classNames)(B,W),onClick:l},r))))};var he=p(662),be=p.n(he),we=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(o[r[i]]=e[r[i]])}return o};const Se=e=>{const t=window.SVG,{className:o}=e,r=we(e,["className"]),n=(0,i.classNames)("jimu-icon jimu-icon-component",o);return t?i.React.createElement(t,Object.assign({className:n,src:be()},r)):i.React.createElement("svg",Object.assign({className:n},r))},xe=e=>{const{activeLayerInfo:t,widgetLabel:o,description:r,activeFeature:a,editCount:s,hasTableLayerAdd:d,featureFormStep:c,onBack:u,onNew:v}=e,f="list"===c||"empty"===c,p="form"===c||"new"===c;let m="";const g=i.hooks.useTranslation(l);if("new"===c)m=g("addFeature");else if("form"===c&&t&&a){const{dataSource:e}=t,o=oe(e);m=a.attributes[o]||""}const y=(0,i.useIntl)(),h=s>1?` (${y.formatNumber(s)})`:"";return(0,i.jsx)("div",{className:(0,i.classNames)({"d-flex":p}),css:i.css`
    border-bottom: 1px solid var(--sys-color-divider-secondary);
    .esri-feature-form__input:focus,
    calcite-input:focus{
      outline: unset !important;
      outline-offset: unset !important;
    }
    .esri-feature-form{
      background-color: unset;
      .esri-feature-form__form-header{
        margin: 0;
        .esri-feature-form__description-text{
          font-weight: 500;
          font-size: 13px;
          margin: 0;
        }
      }
    }
    .esri-editor__header{
      min-height: 56px;
      .esri-widget__heading{
        font-weight: 600;
        font-size: 16px;
        margin: 0 8px;
        text-align: left;
        padding: 1px 0;
        height: 56px;
        line-height: 54px
      }
    }
    .back-button{
      width: 32px;
      padding-inline: 8px;
      padding-block: 4px;
      line-height: 16px;
      color: var(--ref-palette-black);
      border-top: 0px !important;
      border-left: 0px !important;
      border-bottom: 0px !important;
      border-style: solid;
      border-color: var(--sys-color-divider-secondary);
      border-inline-end-width: 1px;
    }
    .add-feature-btn {
      position: absolute;
      right: 15px;
      top: 12px;
      button{
        width: 32px;
        height: 32px;
      }
    }
  `},p&&(0,i.jsx)("button",{id:"back_home",className:(0,i.classNames)("back-button surface-1",U),title:g("back"),onClick:u},"<"),f&&(0,i.jsx)("div",{className:k},(0,i.jsx)("div",{className:C},(0,i.jsx)("h2",{className:N},o+h),r&&(0,i.jsx)("p",{className:(0,i.classNames)(`text-truncate ${R}`),title:r},r))),p&&(0,i.jsx)("header",{className:j},(0,i.jsx)("h4",{className:(0,i.classNames)("text-truncate",N),title:m},m)),d&&f&&(0,i.jsx)(n.Button,{size:"sm",icon:!0,type:"tertiary",className:"add-feature-btn",onClick:v,title:g("addFeature"),"aria-label":g("addFeature")},(0,i.jsx)(Se,{className:"mr-1"}),g("add")))},Ee=e=>{const{buttons:t}=e;return(0,i.jsx)("div",{className:"d-flex justify-content-between form-buttons",css:i.css`
  &.form-buttons{
    border-top: 1px solid var(--sys-color-divider-secondary);
    padding: 12px 15px;
    display: flex;
    .single-button {
      flex: 1;
    }
    .multi-buttons {
      width: 49%;
    }
  }
`},t.map(({disabled:e=!1,label:o,type:r,clickHandler:a},l)=>(0,i.jsx)(n.Button,{key:l,className:(0,i.classNames)({"single-button":1===t.length,"multi-buttons":t.length>1,[I]:e}),type:r,disabled:e,onClick:a},o)))};var Fe=p(170),je=p.n(Fe),Ce=function(e,t){var o={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(o[r[i]]=e[r[i]])}return o};const Re=e=>{const t=window.SVG,{className:o}=e,r=Ce(e,["className"]),n=(0,i.classNames)("jimu-icon jimu-icon-component",o);return t?i.React.createElement(t,Object.assign({className:n,src:je()},r)):i.React.createElement("svg",Object.assign({className:n},r))},Ie=e=>{const{editFeatures:t,layersOrder:o,layersInfo:r,onClickItem:a}=e,[l,s]=i.React.useState(""),d=i.hooks.useTranslation(i.defaultMessages),{count:c,groupedSelectedFeatures:u}=i.React.useMemo(()=>{var e;let i=0;const n=[];for(const o in t){const a=t[o];if(0===a.length||!r[o])continue;const s=null===(e=r[o])||void 0===e?void 0:e.dataSource,d=s.getLabel(),c=oe(s),u=s.getIdField(),v={id:o,dsId:o,label:d,items:a.filter(e=>{var t,o,r,i;const n=(null===(t=e.feature.attributes)||void 0===t?void 0:t[c])||(null===(o=e.feature.attributes)||void 0===o?void 0:o[u])||(null===(r=e.feature.attributes)||void 0===r?void 0:r.objectid),a=l.toLowerCase();return!a||(null===(i=null==n?void 0:n.toString())||void 0===i?void 0:i.toLowerCase().indexOf(a))>-1}).map(e=>{var t,o,r;return{label:(null===(t=e.feature.attributes)||void 0===t?void 0:t[c])||(null===(o=e.feature.attributes)||void 0===o?void 0:o[u])||(null===(r=e.feature.attributes)||void 0===r?void 0:r.objectid),data:e.feature}})};i+=v.items.length,n.push(v)}return n.sort((e,t)=>o.findIndex(t=>t===e.id)-o.findIndex(e=>e===t.id)),{count:i,groupedSelectedFeatures:n}},[t,l,r,o]);return 0===c?(0,i.jsx)("div",{className:D,key:"no-matches"},d("noItemsFound")):(0,i.jsx)("div",{className:"surface-1 border-0",css:i.css`
    flex: 1;
    height: 0;
    .esri-editor__content{
      padding: 8px 16px;
    }
    .feature-list{
      background-color: var(--calcite-color-background);
      max-height: unset;
      .esri-item-list{
        background-color: unset;
      }
      .esri-item-list__list-item{
        background-color: var(--calcite-color-foreground-1);
        :hover{
          cursor: pointer;
          background-color: var(--calcite-color-foreground-2);
        }
      }
      .esri-item-list__group{
        padding: 0 12px;
      }
      .esri-item-list__list-item{
        :focus,
        :focus-visible {
          outline-offset: -2px !important;
        }
      }
      .esri-item-list__list{
        list-style: none;
        margin: 0;
        padding: 0;
        .esri-item-list__list-item{
          cursor: pointer;
          margin-bottom: 6px;
          min-height: 48px;
          transition: border 250ms ease-in-out;
          display: flex;
          justify-content: space-between;
          .esri-item-list__list-item-container{
            display: flex;
            margin: 9px 2px;
            width: 100%;
            .esri-item-list__list-item-label{
              flex: 1;
              margin: 0;
              display: flex;
              align-items: center;
              word-break: break-word;
              padding-left: 20px;
            }
          }
        }
      }
      .esri-editor__scroller{
        overflow-y: auto;
        max-height: unset;
      }
    }
    .esri-editor__scroller{
      overflow-y: auto;
      max-height: unset;
      .esri-item-list__scroller{
        max-height: unset;
      }
    }
  `},(0,i.jsx)("div",{className:(0,i.classNames)("feature-list h-100 overflow-auto",L,O)},(0,i.jsx)("div",{className:(0,i.classNames)(E,F)},(0,i.jsx)("div",{className:"d-flex align-items-center m-2"},(0,i.jsx)(n.TextInput,{className:"w-100",placeholder:d("search"),onChange:e=>{s(e.target.value)},value:l,prefix:(0,i.jsx)(Re,{color:"var(--ref-palette-neutral-700)"}),allowClear:!0,title:l})),(0,i.jsx)("div",{key:"content",className:O},(0,i.jsx)("div",{key:"item-container"},u.map(e=>(0,i.jsx)("div",{role:"group","aria-label":e.label,className:T,key:e.id},(0,i.jsx)("h4",{className:(0,i.classNames)(P,N)},(0,i.jsx)("span",{className:M},e.label)),(0,i.jsx)("div",{className:_,role:"listbox"},e.items.map((t,o)=>(0,i.jsx)(n.Button,{key:`${e.dsId}__${t.label}_${o}`,role:"option",className:(0,i.classNames)(`w-100 border-0 ${V}`),onClick:()=>{a(e.dsId,t.data)}},(0,i.jsx)("div",{className:A},(0,i.jsx)("span",{className:M},t.label))))))))))))},Ne=e=>{const{activeId:t,addLayersConfig:o,onChange:r}=e,a=i.hooks.useTranslation(n.defaultMessages);console.log("FeatureFormSelect -> addLayersConfig:",o,"activeId:",t);const l=i.React.useCallback(e=>{var t;const o=null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value;r(o)},[r]);return(0,i.jsx)("div",{className:"layer-selector",css:i.css`
    &.layer-selector{
      padding: 12px 15px;
    }
  `},(0,i.jsx)("label",{className:"esri-feature-form__label"},a("selectLayer")),(0,i.jsx)(n.Select,{value:t,onChange:l},o.map(e=>(0,i.jsx)("option",{key:e.id,value:e.id},e.name))))};class ke extends i.React.PureComponent{constructor(){super(...arguments),this.onDataSourceCreated=e=>{var t,o,r,i,n;console.log("EditItemDataSource -> onDataSourceCreated:",e);const a=null==e?void 0:e.layerId;e&&"2"===a&&console.log("Layer with layerId=2:",e);const l="2"===(null==e?void 0:e.layerId);if(e&&l){const i=(null===(t=null==e?void 0:e.schema)||void 0===t?void 0:t.fields)||(null===(o=null==e?void 0:e.layerDefinition)||void 0===o?void 0:o.fields)||(null===(r=null==e?void 0:e.fetchedSchema)||void 0===r?void 0:r.fields);console.log("Fields for layerId=2:",i)}null===(n=null===(i=this.props)||void 0===i?void 0:i.onDataSourceCreated)||void 0===n||n.call(i,this.props.useDataSource.dataSourceId,e),console.log(this.props)},this.onSelectionChange=(e,t)=>{var o,r;const i=!((e,t)=>Array.isArray(e)&&Array.isArray(t)&&e.length===t.length&&e.every((e,o)=>t[o]===e))(e,t)&&(0!==(null==e?void 0:e.length)||0!==(null==t?void 0:t.length));i&&(null===(r=(o=this.props).onSelectionChange)||void 0===r||r.call(o,this.props.useDataSource.dataSourceId))},this.onDataSourceInfoChange=(e,t)=>{var o,r;if(!e)return;e.sourceVersion!==(null==t?void 0:t.sourceVersion)&&(null===(r=(o=this.props).onSourceVersionChange)||void 0===r||r.call(o,this.props.useDataSource.dataSourceId,e.sourceVersion))}}render(){const{useDataSource:e}=this.props;return console.log("EditItemDataSource -> props:",this.props),(0,i.jsx)(i.DataSourceComponent,{useDataSource:e,onDataSourceCreated:this.onDataSourceCreated,onSelectionChange:this.onSelectionChange,onDataSourceInfoChange:this.onDataSourceInfoChange})}}const Oe=e=>{console.log("EditListDataSource -> props:",e);const{useDataSources:t,unsavedChange:o,onDataSourceCreated:r,onSelectionChange:a,onSourceVersionChange:s}=e,[d,c]=i.React.useState(!1),u=i.React.useRef([]),v=i.React.useRef(null),f=i.React.useCallback(()=>{u.current.length>0&&(null!==v.current&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{null==a||a(u.current),u.current=[]},500))},[a]),p=i.React.useCallback(e=>{u.current.includes(e)||u.current.push(e),o?c(!0):f()},[f,o]),m=i.React.useCallback(()=>{c(!1),f()},[f]),g=i.React.useCallback(()=>{c(!1)},[]);i.React.useEffect(()=>{o||f()},[f,o]);const y=i.hooks.useTranslation(l);return console.log("EditListDataSource -> useDataSources:",t,"unsavedChange:",o),(0,i.jsx)(i.React.Fragment,null,null==t?void 0:t.map(e=>(0,i.jsx)(ke,{key:e.dataSourceId,useDataSource:e,onDataSourceCreated:r,onSelectionChange:p,onSourceVersionChange:s})),d&&(0,i.jsx)(n.ConfirmDialog,{level:"warning",title:y("selectionChangeConfirmTitle"),hasNotShowAgainOption:!1,content:y("selectionChangeConfirmTips"),confirmLabel:y("discardConfirm"),cancelLabel:y("discardCancel"),onConfirm:m,onClose:g}))};var Le=p(387),_e=p(470),Te=p(633),De=function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(e){n(e)}}function l(e){try{s(r.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,l)}s((r=r.apply(e,t||[])).next())})};const Me=e=>{console.log("useFeatureForm -> options:",e);const{activeId:t,activeLayer:o,activeFeature:r,sourceVersion:n,formTemplate:a,editContainer:l,onValueChange:s}=e,d=i.React.useRef(null),c=i.React.useCallback(()=>{var e,t;(null===(e=d.current)||void 0===e?void 0:e.destroy)&&!(null===(t=d.current)||void 0===t?void 0:t.destroyed)&&d.current.destroy()},[]),u=i.React.useCallback(()=>De(void 0,void 0,void 0,function*(){var e;console.log("renderFeatureForm called");try{c();const n=y(t),u=h(n),v=document&&document.createElement("div");let f;if(l.current.appendChild(v),r){const t=u.getIdField()||"OBJECTID",o=`${t} IN (${r.attributes[t]})`,n=yield u.query({where:o,returnGeometry:!0,notAddFieldsToClient:!0,outFields:["*"]}),a=null===(e=null==n?void 0:n.records)||void 0===e?void 0:e[0];if(!a)return;f=yield i.dataSourceUtils.changeToJSAPIGraphic(a.feature)}else f=new _e.default({layer:o});const p=o.fields;p&&"loaded"===o.loadStatus||(yield o.load(),p&&p.length>0&&o.set({fields:p})),d.current=new Le.default({container:v,feature:f,layer:o,formTemplate:a,timeZone:te(u)});try{yield function(e,t){return De(this,void 0,void 0,function*(){try{if(!t||!t.viewModel)return;let o;"string"==typeof e?(o=new Te.default({url:e}),yield o.load()):(o=e,"loaded"!==o.loadStatus&&o.load&&(yield o.load()));const r=o&&o.fields||[];if(!r||0===r.length)return;const i={};for(const e of r){const t=e.domain,o=t&&(t.codedValues||0===t.codedValues?t.codedValues:null);Array.isArray(o)&&o.length>0&&(i[e.name]=o.map(e=>({name:e.name,code:e.code})))}if(0===Object.keys(i).length)return;const n=t.viewModel,a=n.formTemplate;if(!a)return;const l=a.clone?a.clone():Object.assign({},a),s=(l.elements||[]).map(e=>{if(e&&"field"===e.type&&e.fieldName&&i[e.fieldName]){const t=i[e.fieldName];e.domain=e.domain||{},e.domain.codedValues=t,e.editor=e.editor||{},e.editor.type="select",e.editor.options=e.editor.options||{},e.editor.options.choices=t.map(e=>({label:e.name,value:e.code}))}return e});l.elements=s;try{n.set?n.set("formTemplate",l):n.formTemplate=l}catch(e){try{t.formTemplate=l}catch(e){}}}catch(e){console.error("appendCodedValuesToForm error:",e)}})}(o,d.current)}catch(e){console.warn("appendCodedValuesToForm failed:",e)}d.current.on("value-change",e=>{var t;const o=u.getIdField(),{fieldName:r}=e;if(r===o)return;const i=d.current.viewModel.submittable,n=f.attributes,a=d.current.viewModel.getValues();let l=null;if(a){const e=g((null===(t=d.current.viewModel.formTemplate)||void 0===t?void 0:t.elements)||[]).map(e=>"field"===e.type&&e.valueExpression&&e.fieldName).filter(e=>!!e)||[];for(const t in a)if((null==n?void 0:n[t])!==a[t]){const o=e.includes(t);if(o&&!l&&(l=Ve.Arcade),!o){l=Ve.Normal;break}}}s(l,i)})}catch(e){console.error(e)}}),[r,t,o,c,l,a,s]),v=i.React.useRef(null);return i.React.useEffect(()=>{window.clearTimeout(v.current),v.current=window.setTimeout(()=>{t&&o&&l.current?u():c()},500)},[t,o,n,l,c,u]),i.React.useEffect(()=>{(new Le.default).destroy()},[]),d};var Ae=function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(e){n(e)}}function l(e){try{s(r.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,l)}s((r=r.apply(e,t||[])).next())})};var Ve;!function(e){e.Arcade="arcade",e.Normal="normal"}(Ve||(Ve={}));const Pe=e=>{var o,r;console.log("FeatureFormComponent props:",e);const{label:s,config:d,canEditFeature:c,useDataSources:u,zoneLayerUrl:p}=e,{description:m,layersConfig:g,noDataMessage:b}=d,[w,S]=i.React.useState(null),[x,E]=i.React.useState(null),[F,j]=i.React.useState({}),[C,R]=i.React.useState(null),[I,N]=i.React.useState({}),[k,O]=i.React.useState((0,i.Immutable)([])),[L,_]=i.React.useState(!1),[T,D]=i.React.useState(!1),[M,A]=i.React.useState(null),[V,P]=i.React.useState(!1),[U,$]=i.React.useState(!1),B=i.React.useRef(),J=i.React.useMemo(()=>I[w],[w,I]),W=i.hooks.useTranslation(l,i.defaultMessages,n.defaultMessages);i.React.useEffect(()=>{const e=Object.assign({},F);let t=!1;for(const o in F){g.find(e=>e.id===o)||(delete e[o],t=!0)}t&&j(e)},[F,g]);const G=i.React.useRef(!1),z=i.React.useCallback(e=>Ae(void 0,void 0,void 0,function*(){const t=e.feature;if(!t)return;(null==t?void 0:t.geometry)&&(t.geometry=null);const o=e.getValues();Object.keys(o).forEach(e=>{t.attributes[e]=o[e]});const r={updateFeatures:[t]};$(!0),G.current=!0,A(null),yield le(J,r),ae(J.dataSource,r),$(!1)}),[J]),H=i.React.useCallback((e,t)=>{A(e),P(t)},[]),Z=Me({activeId:w,activeFeature:x,sourceVersion:C,activeLayer:null==J?void 0:J.layer,formTemplate:null==J?void 0:J.formTemplate,editContainer:B,onValueChange:H,zoneLayerUrl:p}),q=i.React.useRef(null);i.React.useEffect(()=>{var e,t,o,r,i;const n=null===(e=Z.current)||void 0===e?void 0:e.viewModel;if(n){try{null===(o=null===(t=q.current)||void 0===t?void 0:t.remove)||void 0===o||o.call(t)}catch(e){}return q.current=null===(i=(r=n).on)||void 0===i?void 0:i.call(r,"submit",e=>{var t,o,r,i,a;try{console.log("FeatureForm submit event fired:",e);const l=null!==(r=null===(o=(t=n).getValues)||void 0===o?void 0:o.call(t))&&void 0!==r?r:{};console.log("Form values at submit:",l);const s=null!==(i=n.feature)&&void 0!==i?i:x;console.log("Feature graphic at submit:",s),console.log("Feature geometry at submit:",null!==(a=null==s?void 0:s.geometry)&&void 0!==a?a:null)}catch(e){console.warn("Error in FeatureForm submit handler:",e)}}),()=>{var e,t;try{null===(t=null===(e=q.current)||void 0===e?void 0:e.remove)||void 0===t||t.call(e)}catch(e){}q.current=null}}},[Z,x]),i.React.useEffect(()=>{var e,t,o;const r=null===(e=Z.current)||void 0===e?void 0:e.viewModel;if(!r)return;const i=new Set,n=null===(o=(t=r).watch)||void 0===o?void 0:o.call(t,"feature",e=>Ae(void 0,void 0,void 0,function*(){var t,o,n,a,l;try{if(!e)return;const s=(e=>{var t,o;try{const r=null===(o=null===(t=null==J?void 0:J.dataSource)||void 0===t?void 0:t.getIdField)||void 0===o?void 0:o.call(t),i=r&&(null==e?void 0:e.attributes)?e.attributes[r]:void 0;return null!=i?`oid:${i}`:e.uid?`uid:${e.uid}`:`geom:${JSON.stringify(e.geometry||{})}`}catch(e){return`fallback:${Date.now()}`}})(e);if(i.has(s))return;i.add(s);const d=null===(o=null===(t=null==J?void 0:J.dataSource)||void 0===t?void 0:t.getIdField)||void 0===o?void 0:o.call(t);if(d&&e.attributes&&void 0!==e.attributes[d]&&null!==e.attributes[d])console.log("FeatureForm opened for existing feature (edit) \u2014 skipping initial-only fetch.");else{const e=null!==(l=null!==(a=null!==(n=null==J?void 0:J.layer)&&void 0!==n?n:r.layer)&&void 0!==a?a:r.featureLayer)&&void 0!==l?l:null;if(!e)return void console.log("FeatureForm opened for NEW feature but no layer available yet.");(e=>{if(!e)return!1;const t=(e.title||e.name||"").toString();if(/service\s*request/i.test(t))return!0;if(void 0!==e.layerId&&2===Number(e.layerId))return!0;if(void 0!==e.id&&2===Number(e.id))return!0;const o=(e.url||"").toString().match(/\/(\d+)(?:\/)?$/);return!(!o||2!==Number(o[1]))})(e)?yield(e=>Ae(void 0,void 0,void 0,function*(){try{console.log("*** Service Request Layer matched ***"),console.log("layer.id:",e.id),console.log("layer.layerId:",e.layerId),console.log("layer.title/name:",e.title||e.name),console.log("layer.url:",e.url)}catch(e){console.warn("fetchDetailsForLayer error:",e)}}))(e):console.log("FeatureForm opened for NEW feature but layer is not Service Request / id=2.")}}catch(e){console.warn("Error in FeatureForm initial-open watch:",e)}}));return()=>{var e;try{null===(e=null==n?void 0:n.remove)||void 0===e||e.call(n)}catch(e){}}},[Z,J]);const K="full"===(null==J?void 0:J.privilege),Q="normal"===(null==J?void 0:J.privilege),te=(null==J?void 0:J.isPublic)||c||K,re=g.find(e=>e.id===w),ne=null===(r=null===(o=null==J?void 0:J.dataSource)||void 0===o?void 0:o.getLayerDefinition)||void 0===r?void 0:r.call(o),{create:se,update:de,deletable:ce}=v(ne),ue=(null==re?void 0:re.updateRecords)&&de,fe=(null==re?void 0:re.deleteRecords)&&ce,pe=(null==re?void 0:re.addRecords)&&se,me=(null==ne?void 0:ne.type)===i.SupportedLayerServiceTypes.Table,ge=[],he=i.React.useCallback(()=>{var e;const t=null===(e=Z.current)||void 0===e?void 0:e.viewModel;(null==t?void 0:t.submittable)&&z(Z.current)},[Z,z]);(K||Q&&ue)&&ge.push({label:W("update"),type:"primary",disabled:!(M&&V),clickHandler:he});const be=i.React.useCallback(()=>{_(!0)},[]),we=i.React.useCallback(()=>{_(!1)},[]),Se=i.React.useCallback(()=>Ae(void 0,void 0,void 0,function*(){var e;const t=null==J?void 0:J.dataSource,o=null===(e=null==t?void 0:t.getSelectedRecords())||void 0===e?void 0:e[0],r=null==o?void 0:o.feature;if(r){const e={deleteFeatures:[r]};$(!0),A(null),yield le(J,e),ae(J.dataSource,e),$(!1)}_(!1)}),[J]);(K||Q&&fe)&&ge.push({label:W("delete"),type:"default",clickHandler:be});const Fe=[],je=i.React.useCallback(()=>Ae(void 0,void 0,void 0,function*(){var e;const t=null===(e=Z.current)||void 0===e?void 0:e.viewModel;if(null==t?void 0:t.submittable){const e=null==t?void 0:t.feature;if(e){const t=Z.current.getValues();e.attributes=t;const o={addFeatures:[e]};$(!0),A(null),yield le(J,o),ae(J.dataSource,o),S(null),$(!1)}}}),[J,Z]);me&&(K||Q&&pe)&&Fe.push({label:W("add"),type:"primary",disabled:!1,clickHandler:je});const Ce=i.React.useCallback(()=>{const e=Y(F);if(1===e.length){let t=!0;const o=e[0],r=o.dataSource,i=r.getSelectedRecordIds();(i.length>1||!i.includes(o.getId()))&&(t=!1),r&&t&&r.clearSelection()}A(null),D(!1),S(null),E(null)},[F]),Re=i.React.useCallback(()=>{M?D(!0):Ce()},[M,Ce]),ke=i.React.useCallback(()=>{D(!1)},[]),Le=i.React.useCallback((e,t)=>{S(e),E(t)},[]);i.React.useEffect(()=>{const e=g.filter(e=>{const t=I[e.id];if(!t)return!1;const o=t.dataSource.getLayerDefinition(),r=(null==o?void 0:o.type)===i.SupportedLayerServiceTypes.Table;return(t.isPublic||c)&&r&&("full"===t.privilege||"normal"===t.privilege&&e.addRecords)});O(e)},[c,g,I]);const _e=i.React.useCallback(()=>{console.log("FeatureFormComponent -> handleNew");const e=k[0].id;S(e),E(null)},[k]),Te=i.React.useCallback(e=>Ae(void 0,void 0,void 0,function*(){var o,r;try{const i=y(e),n=h(i),l=yield n.createJSAPILayerByDataSource();let s;const d=g.filter(t=>t.id===e)[0];if(!d)return;if(d.layerHonorMode===t.Webmap)s=l.formTemplate;else{const e=f(n.getLayerDefinition()),t=((null===(o=l.formTemplate)||void 0===o?void 0:o.elements)||[]).filter(e=>"field"===e.type),r=ie(d.groupedFields.asMutable({deep:!0}),e,t);s=l.formTemplate?l.formTemplate.clone():new a.default,s.elements=r}const c=yield ee(n),u=l.userHasFullEditingPrivileges,v=null===(r=l.editingEnabled)||void 0===r||r;let p;p=c||u&&v?"full":v?"normal":"none";const m=yield X(l.url);return{id:d.id,dataSource:n,layer:l,formTemplate:s,isPublic:m,privilege:p}}catch(e){console.error(e)}}),[g]),De=i.React.useCallback(e=>Ae(void 0,void 0,void 0,function*(){const t=yield Te(e);N(o=>{const r={};for(const i of g)i.id===e?r[i.id]=t:o[i.id]&&(r[i.id]=o[i.id]);return r})}),[Te,g]),Pe=i.hooks.useLatest(w);i.React.useEffect(()=>{Ae(void 0,void 0,void 0,function*(){const e={};for(const t of g){const o=t.id;y(o)&&(e[t.id]=yield Te(t.id))}N(e),Pe.current&&!e[Pe.current]&&(S(null),E(null))})},[g,Te,Pe]);const Ue=i.hooks.useLatest(F),$e=i.React.useCallback((e,t)=>Ae(void 0,void 0,void 0,function*(){const o=Object.assign({},Ue.current);console.log("handleSelectionChange -> dataSourceIds:",e,"sourceVersion:",t);for(const t of e){const e=y(t);if(!e)return;let r=e.getSelectedRecords();const i=Object.keys(e.getSchema().fields||{}),n=e.getIdField(),a=oe(e);if(r.length>0&&!r[0].getFieldValue(a)&&i.includes(a))try{const t=r.map(e=>e.getId()),o=yield e.query({outFields:[n,a],where:`${n} in (${t.join(",")})`});o.records&&(r=o.records)}catch(e){console.error(e)}o[t]=r}j(o),A(null);if(1===Y(o).length){const[e,r]=Object.entries(o).find(([e,t])=>t.length>0);S(e),R(t),E(r[0].feature)}else S(null),E(null)}),[Ue]),Be=i.React.useCallback((e,t)=>{G.current?G.current=!1:$e([e],t)},[$e]),Je=i.React.useMemo(()=>g.map(e=>e.id).asMutable(),[g]),We=Y(F).length,Ge=g.length>0,ze=W("initAttEmptyMessage"),He=Ge?b||W("noRecordTips"):ze;let Ze;Ze=w?x?"form":"new":We>1?"list":"empty";let qe=!1;return"form"===Ze?qe=!ue&&!fe&&K:"new"===Ze&&(qe=!pe&&K),(0,i.jsx)("div",{className:"jimu-widget widget-edit esri-widget",css:i.css`
    &.widget-edit {
      .jimu-loading {
        z-index: 1;
      }
      .edit-con {
        display: flex;
        flex-direction: column;
      }
      .attr-height {
        overflow-y: auto;
        height: calc(100% - 113px);
        .edit-notice {
          margin: 12px 15px;
        }
      }
      .esri-feature-form {
          background-color: unset;
      }
    }
  `},U&&(0,i.jsx)(n.Loading,null),(0,i.jsx)("div",{className:"edit-con surface-1 border-0 h-100 fgfdgdfgdfgdfg"},(0,i.jsx)(xe,{widgetLabel:s,description:m,hasTableLayerAdd:k.length>0,featureFormStep:Ze,activeLayerInfo:J,activeFeature:x,editCount:We,onBack:Re,onNew:_e}),(0,i.jsx)("div",{className:(0,i.classNames)("attr-height",{"d-none":"form"!==Ze&&"new"!==Ze}),ref:B},"new"===Ze&&(0,i.jsx)(Ne,{addLayersConfig:k,activeId:w,onChange:S}),qe&&(0,i.jsx)("calcite-notice",{class:"edit-notice",kind:"brand",open:!0,scale:"s"},(0,i.jsx)("div",{slot:"message"},W("ownerAdminNotice")))),"list"===Ze&&(0,i.jsx)(Ie,{editFeatures:F,layersInfo:I,layersOrder:Je,onClickItem:Le}),"empty"===Ze&&(0,i.jsx)(ve,{emptyTips:He}),"form"===Ze&&ge.length>0&&te&&(0,i.jsx)(Ee,{buttons:ge}),"new"===Ze&&Fe.length>0&&(0,i.jsx)(Ee,{buttons:Fe})),L&&(0,i.jsx)(ye,{title:W("deleteRecord"),message:W("deleteRecordTips"),confirmText:W("delete"),cancelText:W("keepRecord"),onConfirm:Se,onCancel:we}),T&&(0,i.jsx)(ye,{title:W("selectionChangeConfirmTitle"),message:W("selectionChangeConfirmTips"),confirmText:W("discardConfirm"),cancelText:W("discardCancel"),onConfirm:Ce,onCancel:ke}),(0,i.jsx)(Oe,{useDataSources:u,unsavedChange:M===Ve.Normal,onDataSourceCreated:De,onSelectionChange:$e,onSourceVersionChange:Be}))};var Ue=p(686),$e=p(243),Be=p(190),Je=p.n(Be),We=p(816),Ge=function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(e){n(e)}}function l(e){try{s(r.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,l)}s((r=r.apply(e,t||[])).next())})};const ze=e=>{const{config:t,jimuMapView:o,editContainer:n,canEditFeature:a,onRootFeatureChange:l,onCreateFeature:s}=e,{mapViewsConfig:c,relatedRecords:u,liveDataEditing:v}=t,f=i.React.useRef(null),p=i.React.useRef(null),m=i.React.useRef(null),g=i.React.useRef(new Set),b=i.React.useRef(new Map),w=e=>{if(!e)return!1;const t=(e.title||e.name||"").toString();if(/service\s*request/i.test(t))return!0;if(void 0!==e.layerId&&2===Number(e.layerId))return!0;if(void 0!==e.id&&2===Number(e.id))return!0;const o=(e.url||"").toString().match(/\/(\d+)(?:\/)?$/);return!(!o||2!==Number(o[1]))};i.React.useEffect(()=>{const e=f.current;if(console.log("use-editor -> editorWidget:",e),!e)return;const t=e.viewModel;if(!t)return;const o=new Set,r=$e.watch(()=>{var e,o;return null===(o=null===(e=null==t?void 0:t.activeWorkflow)||void 0===e?void 0:e.data)||void 0===o?void 0:o.rootFeature},r=>Ge(void 0,void 0,void 0,function*(){var i,n,a,l,s,d;try{if(!r)return;const c=(e=>{try{if(!e)return`null-${Date.now()}`;const t=(null==e?void 0:e.attributes)&&Object.keys(e.attributes).find(e=>/objectid/i.test(e)),o=t?e.attributes[t]:void 0;return null!=o?`oid:${o}`:(null==e?void 0:e.uid)?`uid:${e.uid}`:`geom:${JSON.stringify(e.geometry||{})}`}catch(e){return`fallback:${Date.now()}`}})(r);if(o.has(c))return;const u=(null==r?void 0:r.attributes)?Object.keys(r.attributes).find(e=>/objectid/i.test(e)):void 0;if(u&&r.attributes&&void 0!==r.attributes[u]&&null!==r.attributes[u])console.log("use-editor: form opened for existing feature edit \u2014 skipping initial-only fetch.");else{o.add(c);let r=null!==(s=null!==(n=null===(i=null==t?void 0:t.activeWorkflow)||void 0===i?void 0:i.layer)&&void 0!==n?n:null===(l=null===(a=null==t?void 0:t.activeWorkflow)||void 0===a?void 0:a.layerView)||void 0===l?void 0:l.layer)&&void 0!==s?s:null;if(!r&&Array.isArray(null==e?void 0:e.layerInfos)){const t=(e.layerInfos||[]).find(e=>{try{const t=e.layer;return w(t)}catch(e){return!1}});r=null!==(d=null==t?void 0:t.layer)&&void 0!==d?d:null}if(!r)return void console.log("use-editor: Could not resolve layer for the opened form (rootFeature).");w(r)?yield(e=>Ge(void 0,void 0,void 0,function*(){try{console.log("fetchDetailsForLayer: matched layer ->",{id:null==e?void 0:e.id,layerId:null==e?void 0:e.layerId,title:(null==e?void 0:e.title)||(null==e?void 0:e.name),url:null==e?void 0:e.url})}catch(e){console.warn("fetchDetailsForLayer error:",e)}}))(r):console.log("use-editor: form opened for a NEW feature, but layer is not Service Request / id=2")}}catch(e){console.warn("use-editor rootFeature watch handler error:",e)}}),{initial:!1});return()=>{var e;try{null===(e=null==r?void 0:r.remove)||void 0===e||e.call(r)}catch(e){}}},[]);const S=i.React.useCallback(()=>{var e,t,o,r;try{if(p.current)try{null===(t=(e=p.current).remove)||void 0===t||t.call(e),p.current=null}catch(e){}if(m.current)try{null===(r=(o=m.current).remove)||void 0===r||r.call(o),m.current=null}catch(e){}g.current.clear();try{for(const[,{layer:e,original:t}]of b.current)try{e&&t&&(e.applyEdits=t)}catch(e){console.warn("Failed to restore original applyEdits for layer",e)}}catch(e){console.warn("Error while restoring applyEdits map",e)}b.current.clear(),f.current&&!f.current.destroyed&&(f.current.destroy(),f.current=null)}catch(e){console.warn("Error while destroying editor or handles:",e)}},[]);i.React.useEffect(()=>()=>{S()},[S]);const[x,E]=i.React.useState([]),[F,j]=i.React.useState(!1),C=i.React.useCallback(()=>{var e,t,r,n;if(!o)return;let l=o.getAllJimuLayerViews();const s=null==c?void 0:c[o.id],f=null==s?void 0:s.customizeLayers,p=null==s?void 0:s.customJimuLayerViewIds,m=(null==s?void 0:s.layersConfig)||(0,i.Immutable)([]);f&&(l=l.sort((e,t)=>m.findIndex(t=>t.id===e.layerDataSourceId)-m.findIndex(e=>e.id===t.layerDataSourceId)));const g=((null===(n=null===(r=null===(t=null===(e=o.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.allLayers)||void 0===r?void 0:r.toArray)||void 0===n?void 0:n.call(r))||[]).filter(e=>{const t=d.includes(e.type),o=!l.find(t=>t.layer===e);return t&&o}),y=l.filter(e=>{const t=e.layer;return d.includes(t.type)}),b=[];y.forEach(e=>{e.layer;const t=function(e,t,o,r){const n=e.layer,a=!!n.url,l=n.id.toString().includes("jimu-draw-measurements-layer"),s=n[i.ExBAddedJSAPIProperties.EXB_NOT_EDITABLE];let d=!0;d=e.fromRuntime?r:!t||o.includes(e.id);const c=e.isLayerVisible();return a&&!l&&!s&&d&&c}(e,f,p,v);t?b.push(e):g.push(e.layer)});const w=g.map(e=>re(e)),S=b.map(e=>Ge(void 0,void 0,void 0,function*(){var t,o,r;const i=yield e.getOrCreateLayerDataSource();if(!i)return null;const n=null===(r=null===(o=null===(t=m.filter(e=>e.id===(null==i?void 0:i.id)))||void 0===t?void 0:t[0])||void 0===o?void 0:o.asMutable)||void 0===r?void 0:r.call(o,{deep:!0}),l=h(i);return ne(l,n,e,u,a)}));Promise.all(S).then(e=>{var t;const r=e.filter(e=>!!e);j(r.some(e=>e.showUpdateBtn));const i=r.map(e=>e.editorLayerInfo).concat(w),n=[],a=o.view.map.allTables.toArray()||[];for(const e of i){if(!((null===(t=e.formTemplate)||void 0===t?void 0:t.elements)||[]).some(e=>"relationship"===e.type))continue;const o=e.layer.relationships;for(const t of o){const o=t.relatedTableId,r=a.find(e=>e.layerId===o);if(!r)continue;n.find(e=>e.layer===r)||n.push({layer:r,enabled:!0,addEnabled:e.addEnabled,updateEnabled:e.updateEnabled,deleteEnabled:e.deleteEnabled})}}E(i.concat(n))})},[a,o,v,c,u]);i.React.useEffect(()=>{C()},[C]);const R=i.hooks.useLatest(C);i.React.useEffect(()=>{var e,t;if(!(null===(t=null===(e=null==o?void 0:o.view)||void 0===e?void 0:e.map)||void 0===t?void 0:t.layers))return;const r=()=>{R.current()};let i=null,n=o.getAllJimuLayerViews().length;const a=e=>{e.fromRuntime?R.current():(i&&window.clearTimeout(i),i=window.setTimeout(()=>{const e=o.getAllJimuLayerViews().length;e!==n&&(R.current(),n=e)},5e3))};return o.addJimuLayerViewsVisibleChangeListener(r),o.addJimuLayerViewCreatedListener(a),o.addJimuLayerViewRemovedListener(a),()=>{var e,t,i;null===(e=null==o?void 0:o.removeJimuLayerViewsVisibleChangeListener)||void 0===e||e.call(o,r),null===(t=null==o?void 0:o.removeJimuLayerViewCreatedListener)||void 0===t||t.call(o,a),null===(i=null==o?void 0:o.removeJimuLayerViewRemovedListener)||void 0===i||i.call(o,a)}},[o,R]);const I=i.React.useCallback(()=>Ge(void 0,void 0,void 0,function*(){var e;const i=f.current;if(!i)return;const{selfSnapping:n,featureSnapping:a,gridSnapping:l=!1,defaultSelfEnabled:s,defaultFeatureEnabled:d,defaultGridEnabled:c=!1,snapSettingMode:u,defaultSnapLayers:v,tooltip:p,defaultTooltipEnabled:m=!1,segmentLabel:g=!0,defaultSegmentLabelEnabled:y=!1,templateFilter:h,initialReshapeMode:b,batchEditing:w=!1}=t;try{i.tooltipOptions.enabled=m,i.labelOptions.enabled=y,i.snappingOptions.enabled=s||d||c,i.snappingOptions.selfEnabled=s,i.snappingOptions.featureEnabled=d,i.snappingOptions.gridEnabled=c&&l,i.snappingOptions.featureSources=yield Ue.SnappingUtils.getSnappingFeatureSourcesCollection(o,v);const t=u===r.Flexible,f=t&&(n||a||l);i.visibleElements.selectionToolbar=w,i.visibleElements.snappingControls=f,i.visibleElements.snappingControlsElements={enabledToggle:n||a||l,selfEnabledToggle:n,featureEnabledToggle:a,layerList:a,layerListToggleLayersButton:a,gridEnabledToggle:l,gridControls:l},i.visibleElements.tooltipsToggle=p,i.visibleElements.labelsToggle=g;const S=f||p||g&&"3d"===(null===(e=o.view)||void 0===e?void 0:e.type);i.visibleElements.settingsMenu=S,i.supportingWidgetDefaults={featureTemplates:{visibleElements:{filter:h}},sketch:{defaultUpdateOptions:{tool:b?"reshape":"transform"}}}}catch(e){console.warn("Failed updating editor widget config:",e)}}),[t,o]),N=i.hooks.usePrevious(o),k=i.hooks.usePrevious(t),O=i.React.useCallback((e,t)=>Ge(void 0,void 0,void 0,function*(){var r;if(!(null===(r=f.current)||void 0===r?void 0:r.viewModel.syncing))return;const i=o.getDataSourceIdByAPILayer(e),n=y(i);if(!n)return;const a=e.objectIdField,l=(t.addedFeatures||[]).map(e=>e.objectId);let s=[];if(l.length>0){const t=yield e.queryFeatures({where:`${a} IN (${l.join(",")})`,outFields:["*"],returnGeometry:!1});s=(null==t?void 0:t.features)||[]}const d=(t.updatedFeatures||[]).map(e=>e.objectId);let c=[];if(d.length>0){const t=yield e.queryFeatures({where:`${a} IN (${d.join(",")})`,outFields:["*"],returnGeometry:!1});c=(null==t?void 0:t.features)||[]}const u=(t.deletedFeatures||[]).map(e=>new _e.default({attributes:{[a]:e.objectId}}));ae(n,{addFeatures:s,updateFeatures:c,deleteFeatures:u})}),[o]),L=i.React.useCallback((e,t=5e3)=>new Promise(o=>{var r,i;if(!e)return o(null);try{const n=null===(i=null===(r=null==e?void 0:e.activeWorkflow)||void 0===r?void 0:r.data)||void 0===i?void 0:i.rootFeature;if(null==n?void 0:n.geometry)return o(n);const a=$e.watch(()=>{var t,o,r;return null===(r=null===(o=null===(t=null==e?void 0:e.activeWorkflow)||void 0===t?void 0:t.data)||void 0===o?void 0:o.rootFeature)||void 0===r?void 0:r.geometry},t=>{var r,i,n;if(t){try{null===(r=a.remove)||void 0===r||r.call(a)}catch(e){}o(null===(n=null===(i=null==e?void 0:e.activeWorkflow)||void 0===i?void 0:i.data)||void 0===n?void 0:n.rootFeature)}});t&&"number"==typeof t&&setTimeout(()=>{var e;try{null===(e=a.remove)||void 0===e||e.call(a)}catch(e){}o(null)},t)}catch(e){console.warn("waitUntilGeometry error",e),o(null)}}),[]),_=e=>{try{const t=null==e?void 0:e.geometry;if(!t)return"UNKNOWN";let o=0,r=0;if(void 0!==t.x&&void 0!==t.y)o=t.x,r=t.y;else if(t.centroid&&void 0!==t.centroid.x)o=t.centroid.x,r=t.centroid.y;else if(t.rings&&t.rings.length&&t.rings[0].length){const e=t.rings[0][0];o=e[0],r=e[1]}return o<-1e7?"ZONE_A":o<0?"ZONE_B":"ZONE_C"}catch(e){return console.warn("computeZoneForFeature error",e),"UNKNOWN"}},T=e=>Ge(void 0,void 0,void 0,function*(){var o,r,i,n,a,l,s;try{if(!e||!e.geometry)return e;const d=(null==t?void 0:t.serviceRequest)||{},c=(null==d?void 0:d.ZoneLayer)||(null==d?void 0:d.zoneLayerUrl)||null,u=(null==d?void 0:d.Zone2Layer)||(null==d?void 0:d.zone2LayerUrl)||null,v=(null==d?void 0:d.TechnicianLayerURL)||(null==d?void 0:d.technicianLayerUrl)||null,f=(null==t?void 0:t.fieldInfo)||{},p=(null===(o=null==f?void 0:f.CommonField)||void 0===o?void 0:o.NAME)||"NAME",m=(null===(r=null==f?void 0:f.CommonField)||void 0===r?void 0:r.ZONE)||"ZONE",g=(null===(i=null==f?void 0:f.TechnicianFields)||void 0===i?void 0:i.SUPERVISOR)||"SUPERVISOR",y=(null===(n=null==f?void 0:f.TechnicianFields)||void 0===n?void 0:n.NAME)||"TECH_NAME";e.attributes||(e.attributes={});const h=null===e.attributes[m]||void 0===e.attributes[m],b={geometry:e.geometry,spatialRelationship:"intersects",outFields:["*"],returnGeometry:!1,where:"1=1"},w=(e,t)=>Ge(void 0,void 0,void 0,function*(){if(!e)return null;try{const o=new Te.default({url:e});let r=null;t&&(r=t.toJSON?t.toJSON():t);const i=o.createQuery();r&&(i.geometry=r,i.spatialRelationship="intersects"),i.outFields=["*"];const n=yield o.queryFeatures(i);return n&&n.features&&n.features.length>0?n.features:null}catch(t){return console.warn("queryLayer error for url",e,t),null}});if(h&&c){const t=yield w(c);if(t&&t.length>0){const o=null===(a=t[0].attributes)||void 0===a?void 0:a[p];o&&(e.attributes[m]=o)}}if(u){const t=yield w(u);if(t&&t.length>0){const o=null===(l=t[0].attributes)||void 0===l?void 0:l[p];o&&(e.attributes.ZONE2=o)}}if(v){const t=e.attributes[m];let o=b;t&&(o=Object.assign(Object.assign({},b),{where:`${(null===(s=null==f?void 0:f.CommonField)||void 0===s?void 0:s.ZONE)||"ZONE"}='${t}'`}));try{const t=new Te.default({url:v}),r=yield t.queryFeatures(o);if(r&&r.features&&r.features.length>0){const t=r.features[0].attributes||{};t[g]&&(e.attributes.SUPERVISOR=t[g]),t[y]&&(e.attributes.ASSIGNEDTECH=t[y])}}catch(e){console.warn("technician layer query error",e)}}return e}catch(t){return console.warn("enrichFeatureWithZoneAndTech error",t),e}});i.React.useEffect(()=>{var e,r,i,a,d,c;if(o&&n.current)if(f.current&&o===N)t!==k&&I();else{S();const t=document.createElement("div");t.className="h-100",n.current.appendChild(t),f.current=new We.default({container:t,view:o.view}),I();try{const t=f.current.viewModel;if(t){if(p.current){try{null===(r=(e=p.current).remove)||void 0===r||r.call(e)}catch(e){}p.current=null}p.current=$e.watch(()=>{var e,o;return null===(o=null===(e=null==t?void 0:t.activeWorkflow)||void 0===e?void 0:e.data)||void 0===o?void 0:o.rootFeature},e=>{var t;try{if(e)try{const o=(null==e?void 0:e.attributes)&&Object.keys(e.attributes).find(e=>/objectid/i.test(e)),r=o?e.attributes[o]:void 0,i=null!==(t=null!=r?r:null==e?void 0:e.uid)&&void 0!==t?t:JSON.stringify(e.geometry||{});g.current.has(i)||(g.current.add(i),console.log("Editor rootFeature changed -> attributes:",e.attributes),console.log("Editor rootFeature changed -> geometry:",e.geometry))}catch(e){console.warn("Error logging rootFeature contents",e)}if("function"==typeof l)try{l(e)}catch(e){console.warn("onRootFeatureChange callback error:",e)}}catch(e){console.warn("rootFeature watch handler error:",e)}},{initial:!0})}if(m.current){try{null===(a=(i=m.current).remove)||void 0===a||a.call(i)}catch(e){}m.current=null}const o=(e,...t)=>Ge(void 0,[e,...t],void 0,function*(e,t="create"){var o,r,i,n;try{if(!e)return;const a=null===(r=null===(o=null==e?void 0:e.activeWorkflow)||void 0===o?void 0:o.data)||void 0===r?void 0:r.rootFeature;if(a&&a.geometry){const e=(null==a?void 0:a.attributes)&&Object.keys(a.attributes).find(e=>/objectid/i.test(e)),o=e?a.attributes[e]:void 0,r=null!==(i=null!=o?o:null==a?void 0:a.uid)&&void 0!==i?i:JSON.stringify(a.geometry||{});return void(g.current.has(r)||(g.current.add(r),console.log(`[Editor][${t}] rootFeature (immediate) -> attributes:`,a.attributes),console.log(`[Editor][${t}] rootFeature (immediate) -> geometry:`,a.geometry)))}const l=yield L(e);if(l){const e=(null==l?void 0:l.attributes)&&Object.keys(l.attributes).find(e=>/objectid/i.test(e)),o=e?l.attributes[e]:void 0,r=null!==(n=null!=o?o:null==l?void 0:l.uid)&&void 0!==n?n:JSON.stringify(l.geometry||{});g.current.has(r)||(g.current.add(r),console.log(`[Editor][${t}] rootFeature (when) -> attributes:`,l.attributes),console.log(`[Editor][${t}] rootFeature (when) -> geometry:`,l.geometry))}else console.warn(`[Editor][${t}] rootFeature did not appear with geometry within wait period`)}catch(e){console.warn("[Editor] waitAndLogRootFeature error:",e)}});try{m.current=null===(c=(d=f.current).on)||void 0===c?void 0:c.call(d,"create",e=>{var t,r,i;try{if(null==e?void 0:e.graphic){try{const o=e.graphic,r=(null==o?void 0:o.attributes)&&Object.keys(o.attributes).find(e=>/objectid/i.test(e)),i=r?o.attributes[r]:void 0,n=null!==(t=null!=i?i:null==o?void 0:o.uid)&&void 0!==t?t:JSON.stringify(o.geometry||{});g.current.has(n)||(g.current.add(n),console.log("create event graphic attributes:",o.attributes),console.log("create event graphic geometry:",o.geometry))}catch(e){console.warn("Error logging evt.graphic",e)}if("function"==typeof s)try{s(e)}catch(e){console.warn("onCreateFeature callback error:",e)}const i=null===(r=f.current)||void 0===r?void 0:r.viewModel;return void o(i,"create-after-evtGraphic")}const n=null===(i=f.current)||void 0===i?void 0:i.viewModel;if(o(n,"create"),"function"==typeof s)try{s(e)}catch(e){console.warn("onCreateFeature callback error:",e)}}catch(e){console.warn("Error in create event handler:",e)}})}catch(e){console.warn("Failed to attach create handler on editor",e)}}catch(e){console.warn("Failed to create rootFeature watch or attach create handler:",e)}}},[t,S,n,o,k,N,I,l,s,L]),i.React.useEffect(()=>{const e=f.current;if(!e)return;const t=[];for(const e of x){if(!e.enabled)continue;const o=e.layer;if("subtype-sublayer"===o.type){const e=o.parent,r=null==e?void 0:e.on("edits",t=>{O(e,t)});t.push(r);try{const t=(null==e?void 0:e.uid)||(null==e?void 0:e.id)||Math.random().toString(36).slice(2);if(!b.current.has(t)&&(null==e?void 0:e.applyEdits)){const o=e.applyEdits.bind(e);b.current.set(t,{layer:e,original:o}),e.applyEdits=t=>Ge(void 0,void 0,void 0,function*(){var r,i,n,a;try{const o=e=>Ge(void 0,void 0,void 0,function*(){if(!e)return e;e.attributes||(e.attributes={});if(null!==e.attributes.ZONE&&void 0!==e.attributes.ZONE){const t=null===e.attributes.ASSIGNEDTECH||void 0===e.attributes.ASSIGNEDTECH,o=null===e.attributes.SUPERVISOR||void 0===e.attributes.SUPERVISOR;if(t||o)try{e=yield T(e)}catch(e){console.warn("enrichment failed for tech fields",e)}}else try{e=yield T(e)}catch(t){console.warn("enrichment failed, falling back to computeZoneForFeature",t),e.attributes.ZONE=_(e)}return e});if(null===(r=null==t?void 0:t.addFeatures)||void 0===r?void 0:r.length){const e=t.addFeatures.map(e=>o(e));t.addFeatures=yield Promise.all(e)}if(null===(i=null==t?void 0:t.updateFeatures)||void 0===i?void 0:i.length){const e=t.updateFeatures.map(e=>o(e));t.updateFeatures=yield Promise.all(e)}try{const o=[];if((null===(n=null==t?void 0:t.addFeatures)||void 0===n?void 0:n.length)&&t.addFeatures.forEach((t,r)=>{const i=D(t,e);i.valid||o.push({op:"add",index:r,missing:i.missing})}),(null===(a=null==t?void 0:t.updateFeatures)||void 0===a?void 0:a.length)&&t.updateFeatures.forEach((t,r)=>{const i=D(t,e);i.valid||o.push({op:"update",index:r,missing:i.missing})}),o.length){const e=o.map(e=>`${e.op}[${e.index}]: ${e.missing.join(",")}`).join("; ");return console.warn("Validation failed - required fields missing for features:",e),Promise.reject(new Error(`Validation failed - required fields missing: ${e}`))}}catch(e){console.warn("Validation check error (subtype group):",e)}}catch(e){console.warn("applyEdits wrapper error (subtype group):",e)}return o(t)})}}catch(e){console.warn("Failed to patch applyEdits for subtype group layer",e)}}else{const e=o,r=e.on("edits",t=>{O(e,t)});t.push(r);try{const t=(null==e?void 0:e.uid)||(null==e?void 0:e.id)||Math.random().toString(36).slice(2);if(!b.current.has(t)&&(null==e?void 0:e.applyEdits)){const o=e.applyEdits.bind(e);b.current.set(t,{layer:e,original:o}),e.applyEdits=t=>Ge(void 0,void 0,void 0,function*(){var r,i,n,a;try{const o=e=>Ge(void 0,void 0,void 0,function*(){if(!e)return e;e.attributes||(e.attributes={});if(!(null!==e.attributes.ZONE&&void 0!==e.attributes.ZONE))try{return e=yield T(e)}catch(t){console.warn("enrichFeatureWithZoneAndTech failed, falling back to computeZoneForFeature",t);try{e.attributes.ZONE=_(e)}catch(e){console.warn("computeZoneForFeature fallback failed",e)}return e}const t=null===e.attributes.ASSIGNEDTECH||void 0===e.attributes.ASSIGNEDTECH,o=null===e.attributes.SUPERVISOR||void 0===e.attributes.SUPERVISOR;if(t||o)try{e=yield T(e)}catch(e){console.warn("enrichFeatureWithZoneAndTech (tech) failed",e)}return e});if(null===(r=null==t?void 0:t.addFeatures)||void 0===r?void 0:r.length){const e=t.addFeatures.map(e=>o(e));t.addFeatures=yield Promise.all(e)}if(null===(i=null==t?void 0:t.updateFeatures)||void 0===i?void 0:i.length){const e=t.updateFeatures.map(e=>o(e));t.updateFeatures=yield Promise.all(e)}try{const o=[];if((null===(n=null==t?void 0:t.addFeatures)||void 0===n?void 0:n.length)&&t.addFeatures.forEach((t,r)=>{const i=D(t,e);i.valid||o.push({op:"add",index:r,missing:i.missing})}),(null===(a=null==t?void 0:t.updateFeatures)||void 0===a?void 0:a.length)&&t.updateFeatures.forEach((t,r)=>{const i=D(t,e);i.valid||o.push({op:"update",index:r,missing:i.missing})}),o.length){const e=o.map(e=>`${e.op}[${e.index}]: ${e.missing.join(",")}`).join("; ");return console.warn("Validation failed - required fields missing for features:",e),Promise.reject(new Error(`Validation failed - required fields missing: ${e}`))}}catch(e){console.warn("Validation check error (feature layer):",e)}}catch(e){console.warn("applyEdits wrapper error (feature layer):",e)}return o(t)})}}catch(e){console.warn("Failed to patch applyEdits for feature layer",e)}}}return e.layerInfos=x,e.visibleElements.editFeaturesSection=F,()=>{var e;for(const o of t)try{null===(e=o.remove)||void 0===e||e.call(o)}catch(e){}try{for(const[e,{layer:t,original:o}]of b.current){const r=x.some(e=>{var o,r;return(null===(o=e.layer)||void 0===o?void 0:o.uid)===(null==t?void 0:t.uid)||(null===(r=e.layer)||void 0===r?void 0:r.id)===(null==t?void 0:t.id)});if(!r){try{t.applyEdits=o}catch(e){}b.current.delete(e)}}}catch(e){console.warn("Error while restoring applyEdits in cleanup:",e)}}},[x,F,O]);const D=(e,t)=>{try{const o=[],r=(e=>{var t;try{return(e&&(e.fields||(null===(t=null==e?void 0:e.layer)||void 0===t?void 0:t.fields))||[]).filter(e=>e&&e.name&&!1===e.nullable&&!/objectid/i.test(e.name)).map(e=>e.name)}catch(e){return console.warn("getRequiredFieldNames error",e),[]}})(t);if(!r||0===r.length)return{valid:!0,missing:o};const i=(null==e?void 0:e.attributes)||{};for(const e of r){const t=i[e];(null==t||"string"==typeof t&&""===t.trim())&&o.push(e)}return{valid:0===o.length,missing:o}}catch(e){return console.warn("validateFeatureAttributes error",e),{valid:!0,missing:[]}}};return f.current};var He=function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(e){n(e)}}function l(e){try{s(r.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,l)}s((r=r.apply(e,t||[])).next())})};const Ze=e=>{const{config:t,canEditFeature:o,useMapWidgetIds:r,zoneLayerUrl:a}=e,{mapViewsConfig:s,batchEditing:d=!1}=t,[u,v]=i.React.useState(null),[f,p]=i.React.useState(),[m,g]=i.React.useState({}),w=i.hooks.useTranslation(l),S=i.React.useRef(null),E=ze({config:t,jimuMapView:u,editContainer:S,canEditFeature:o});console.log("EditorComponent props:",E);const F=i.React.useCallback(e=>He(void 0,void 0,void 0,function*(){if(!u||u.isDestroyed()||!e)return;const t=null==s?void 0:s[u.id],o=null==t?void 0:t.customizeLayers,r=null==t?void 0:t.customJimuLayerViewIds,n=[];for(const t of e)try{if(!t.enabled||t.layer.isTable)continue;const e=u.getJimuLayerViewIdByAPILayer(t.layer);if(o&&!(null==r?void 0:r.includes(e)))continue;const a=(yield u.whenJimuLayerViewLoaded(e)).getLayerDataSource();if(!a||!c.includes(a.type))continue;const l=a.getMainDataSource(),s=a.getRootDataSource(),d=(0,i.Immutable)({dataSourceId:a.id,mainDataSourceId:null==l?void 0:l.id,dataViewId:a.dataViewId,rootDataSourceId:null==s?void 0:s.id});n.push(d)}catch(e){continue}p(n)}),[u,s]),j=i.React.useCallback(e=>{v(e)},[]),C=i.React.useCallback(e=>He(void 0,void 0,void 0,function*(){if(!E||!u)return;E.activeWorkflow&&E.cancelWorkflow();const t=E.effectiveSelectionManager;if(0===Q(e,u).length)(null==t?void 0:t.hasSelection)&&t.clear();else{I.current=!0;let o=[];try{o=yield((e,t)=>x(void 0,void 0,void 0,function*(){const o=[];for(const r in t){const i=y(r),n=h(i).getIdField(),a=t[r];if((null==a?void 0:a.length)>0){const i=`${n} IN (${t[r].map(e=>{var t;return(null===(t=e)||void 0===t?void 0:t.feature).attributes[n]}).join()})`,a=e.getJimuLayerViewByDataSourceId(r),l=null==a?void 0:a.layer;if(!l)continue;const s=new b.default({where:i,outFields:["*"],returnGeometry:!0});o.push(l.queryFeatures(s))}}return(yield Promise.all(o)).reduce((e,t)=>Array.isArray(t.features)?e.concat(t.features):e,[])}))(u,e)}catch(e){console.error("Failed to query editing features:",e)}if(0===o.length)(null==t?void 0:t.hasSelection)&&t.clear(),console.error("No features found for the selected data records.");else if(1===o.length){(null==t?void 0:t.hasSelection)&&t.clear();const e=o[0];E.startUpdateWorkflowAtFeatureEdit(e)}else o.length>1&&("2d"===u.view.type&&d?((null==t?void 0:t.hasSelection)&&t.clear(),t&&t.updateSelection({current:o,added:[],removed:[]})):E.startUpdateWorkflowAtMultipleFeatureSelection(o))}}),[d,E,u]),R=i.React.useRef(!1),I=i.React.useRef(!1),N=(e=>{const[t,o]=i.React.useState(!0);return i.React.useEffect(()=>{let t;return e?(t=new IntersectionObserver(e=>{const t=e[0];if(!t)return;const r=t.target.checkVisibility(),i=0===t.boundingClientRect.width||0===t.boundingClientRect.height;o(r&&!i)}),t.observe(e)):o(!1),()=>{t&&t.disconnect()}},[e]),t})(S.current),k=i.React.useCallback(e=>{const t=Object.assign({},m);for(const o of e){const e=y(o);if(!e)continue;const r=e.getSelectedRecords();t[o]=r}g(t),R.current?window.setTimeout(()=>{R.current=!1},50):N&&C(t)},[m,C,N]),O=i.React.useCallback(e=>{const t=Q(m,u).length;(null==E?void 0:E.viewModel.syncing)&&1!==t||k([e])},[m,E,k,u]),L=i.hooks.useLatest(m);i.React.useEffect(()=>{var e,t;N&&!(null===(e=null==E?void 0:E.activeWorkflow)||void 0===e?void 0:e.started)&&C(L.current),!N&&(null===(t=null==E?void 0:E.activeWorkflow)||void 0===t?void 0:t.started)&&E.activeWorkflow.cancel()},[L,E,C,N]);const[_,T]=i.React.useState(!1);i.React.useEffect(()=>{if(!E||!u)return;let e=null;return e=$e.watch(()=>{var e,t,o;return null===(o=null===(t=null===(e=E.viewModel)||void 0===e?void 0:e.activeWorkflow)||void 0===t?void 0:t.data)||void 0===o?void 0:o.rootFeature},e=>He(void 0,void 0,void 0,function*(){e&&(console.log("\u{1f50e} Selected Feature Attributes:",e.attributes),console.log("\u{1f4d0} Selected Feature Geometry:",e.geometry),e.geometry)}),{initial:!0}),()=>{var t;try{null===(t=null==e?void 0:e.remove)||void 0===t||t.call(e)}catch(e){}}},[E,u]),i.React.useEffect(()=>{if(!E)return;const e=$e.watch(()=>null==E?void 0:E.layerInfos,e=>{F(e)},{initial:!0});return()=>{var t;try{null===(t=null==e?void 0:e.remove)||void 0===t||t.call(e)}catch(e){}}},[E,F]);const D=null==r?void 0:r[0];return(0,i.jsx)("div",{className:"jimu-widget widget-edit esri-widget"},(0,i.jsx)("div",{className:"editor-component-root"}),D&&(0,i.jsx)("div",{className:"edit-con h-100",ref:S}),!D&&(0,i.jsx)(n.WidgetPlaceholder,{autoFlip:!0,icon:Je(),name:w("_widgetLabel"),"data-testid":"editPlaceholder"}),(0,i.jsx)(Ue.JimuMapViewComponent,{useMapWidgetId:D,onActiveViewChange:j}),D&&!u&&(0,i.jsx)("div",{className:"jimu-secondary-loading"}),E&&(0,i.jsx)(Oe,{useDataSources:f,unsavedChange:_,onSelectionChange:k,onSourceVersionChange:O}))};var qe=function(e,t,o,r){return new(o||(o=Promise))(function(i,n){function a(e){try{s(r.next(e))}catch(e){n(e)}}function l(e){try{s(r.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(a,l)}s((r=r.apply(e,t||[])).next())})};class Ke extends i.WidgetVersionManager{constructor(){super(...arguments),this.versions=[{version:"1.7.0",description:"Add layerHonorMode to config for support smart form.",upgrader:e=>qe(this,void 0,void 0,function*(){let o=e;const r=(e,t)=>{const o=[],r=e=>(e.forEach(e=>{if(e.groupKey)r(e.children);else{const r=t.find(t=>t.name===e.jimuName);s.includes(e.jimuName)||o.push(Object.assign(Object.assign({},e),{editable:null==r?void 0:r.editable,editAuthority:!!(null==r?void 0:r.editable)&&(null==e?void 0:e.editAuthority)}))}}),o);return r(e)};return yield Promise.all(o.layersConfig.map(e=>new Promise(t=>{i.DataSourceManager.getInstance().createDataSourceByUseDataSource(e.useDataSource).then(o=>{const i=null==o?void 0:o.getLayerDefinition(),n=(null==i?void 0:i.fields)||[],a=e.groupedFields.map(e=>{var t;const o=n.find(t=>t.name===e.jimuName);return e.groupKey?Object.assign(Object.assign({},e),{editable:!0,editAuthority:!(null===(t=null==e?void 0:e.children)||void 0===t?void 0:t.some(e=>!1===e.editAuthority)),children:r(null==e?void 0:e.children,n)}):Object.assign(Object.assign({},e),{editable:null==o?void 0:o.editable,editAuthority:!!(null==o?void 0:o.editable)&&(null==e?void 0:e.editAuthority)})}).filter(e=>!s.includes(e.jimuName));t(a)}).catch(()=>{t([])})}))).then(e=>(e.forEach((e,r)=>{const n=o.layersConfig[r].showFields.filter(e=>!s.includes(e.jimuName));let a=[];const l=e.asMutable({deep:!0});e.forEach(e=>{e.groupKey?a=a.concat(e.children):a.push(e)}),n.forEach(e=>{a.find(t=>t.jimuName===e.jimuName)||l.push(e)}),o=o.setIn(["layersConfig",r,"groupedFields"],(0,i.Immutable)(l)),o=o.setIn(["layersConfig",r,"layerHonorMode"],t.Custom)}),Promise.resolve(o))).catch(()=>Promise.resolve(o))})},{version:"1.10.0",description:"Set old app default snapping to true",upgrader:e=>{let t=e;return t=t.set("selfSnapping",!0).set("featureSnapping",!0),t}},{version:"1.12.0",description:'Set "undefined" option to "false", and remove not editable layer',upgrader:t=>qe(this,void 0,void 0,function*(){var o,r,n;let a=t;const l=a.editMode===e.Geometry,s=i.DataSourceManager.getInstance(),d=[];for(const e of a.layersConfig){let t;try{t=yield s.createDataSourceByUseDataSource(null==e?void 0:e.useDataSource)}catch(e){console.error(e)}if(!t){d.push(e);continue}const a=null==t?void 0:t.getLayerDefinition(),c=(null===(o=null==t?void 0:t.layer)||void 0===o?void 0:o.isTable)||(null==a?void 0:a.type)===i.SupportedLayerServiceTypes.Table;if(l&&c)continue;const u=null==a?void 0:a.allowGeometryUpdates;if(null===(n=null===(r=null==t?void 0:t.layer)||void 0===r?void 0:r.editingEnabled)||void 0===n||n){let t;t=e.updateGeometries?Object.assign(Object.assign({},e),{updateRecords:!0,updateAttributes:!0,updateGeometries:u&&!0}):Object.assign(Object.assign({},e),{updateRecords:!1,updateAttributes:!1,updateGeometries:!1}),d.push(t)}}return a=a.setIn(["layersConfig"],d),a})},{version:"1.13.0",description:"Update snap options",upgrader:e=>{let t=e;return t.selfSnapping&&(t=t.set("defaultSelfEnabled",!0)),t.featureSnapping&&(t=t.set("defaultFeatureEnabled",!0)),t}},{version:"1.14.0",description:"Add predefine snapping options",upgrader:e=>{let t=e;return t=t.set("snapSettingMode",r.Flexible),t}},{version:"1.15.0",description:"Add general setting options",upgrader:e=>{let t=e;return t=t.set("tooltip",!0).set("templateFilter",!0).set("relatedRecords",!0),t}},{version:"1.16.0",description:"Update map mode config",upgradeFullInfo:!0,upgrader:t=>qe(this,void 0,void 0,function*(){const o=t.widgetJson,r=o.config;if(!r)return t;let n=r;const{editMode:a,layersConfig:l}=r,s={},d=(e,t,o)=>qe(this,void 0,void 0,function*(){try{const r=yield i.DataSourceManager.getInstance().createDataSourceByUseDataSource((0,i.Immutable)({dataSourceId:e,mainDataSourceId:e,rootDataSourceId:t}));if(!r)return console.error("Cannot create layer data source.",e),null;return`${o}-${r.jimuLayerId}`}catch(e){return console.error("Cannot create layer data source.",e),null}});if(a===e.Geometry){const e=o.useMapWidgetIds[0];for(const t of l){const o=t.id,r=o.indexOf("-"),i=t.id.substring(0,r),n=`${e}-${i}`,a=yield d(o,i,n);if(!a)continue;const l=t.asMutable({deep:!0});if(s[n]){s[n].customJimuLayerViewIds.push(a);const e=s[n].layersConfig;e.push(l),s[n].layersConfig=e}else{const e={customizeLayers:!0,customJimuLayerViewIds:[a],layersConfig:[l]};s[n]=e}}n=n.set("mapViewsConfig",s)}const c=o.set("config",(0,i.Immutable)(n));return Object.assign(Object.assign({},t),{widgetJson:c})})}]}}const Ye=new Ke,Qe=t=>{const{label:o,config:r,useDataSources:n,useMapWidgetIds:a}=t,l=r.editMode===e.Attribute,[s,d]=i.React.useState(!1);return i.React.useEffect(()=>{x(void 0,void 0,void 0,function*(){var e;const t=yield i.privilegeUtils.checkExbAccess(i.privilegeUtils.CheckTarget.Experience);return null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.canEditFeature}).then(e=>{d(e)})},[]),console.log("EditWidget -> canEditFeature:",l,s,n,a),l?(0,i.jsx)(Pe,{label:o,config:r,zoneLayerUrl:r.zoneLayerUrl,canEditFeature:s,useDataSources:n}):(0,i.jsx)(Ze,{config:r,canEditFeature:s,useMapWidgetIds:a,zoneLayerUrl:r.zoneLayerUrl})};Qe.versionManager=Ye;const Xe=Qe;function et(e){p.p=e}})(),m})())}}});